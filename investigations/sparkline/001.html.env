<html>
<p>
Example of Sparkline component.
</p>

<!-- Following from: https://reactjs.org/docs/state-and-lifecycle.html -->
<body>

<p>Sparkline ver $SPARKLINE_VER </p>

<div id="root"></div>
<script crossorigin 
  src="https://unpkg.com/react@16/umd/react.development.js">
</script>
<script crossorigin 
  src="https://unpkg.com/react-dom@16/umd/react-dom.development.js">
</script>
<script crossorigin
  src="https://unpkg.com/d3@3.5.9/d3.js">
</script>
<script crossorigin 
  src="https://unpkg.com/babel-standalone@6.26.0/babel.js">
</script>
<script type="text/babel">

// CITATION
// https://redux.js.org/style-guide/style-guide#treat-reducers-as-state-machines
// https://medium.com/strands-tech-corner/react-state-management-without-redux-d39c7087039d
// https://codesandbox.io/s/react-codesandbox-je6cc?file=/src/count.js
// https://kentcdodds.com/blog/how-to-use-react-context-effectively
// https://aheadcreative.co.uk/articles/learning-react-context-api/

// DEPENDENCIES
const { useEffect } = React;

const { 
    range, 
    select,
    scaleLinear 
} = d3;

// NEEDS FIXING
// "http://$SPARKLINE_IP:$HTTP_PORT/json"
const DATA_SERVER_URL = "http://165.227.30.170:$HTTP_PORT/json";

// DEBUG
localStorage.clear();

// MODEL INIT
if (localStorage.getItem("model") !== null) {
    setModel({...getModel()});
}

if (localStorage.getItem("model") === null) {
    setObject("model",
        { 
            isStreamOn: false,
            data: [{ id: 1, type: "random.number", data: 121 }],
            number: 0
        }
    );
}

const MOUNT_POINT = document.getElementById("root");

// MODEL
function updateView(mountPoint = MOUNT_POINT) {
    ReactDOM.render(<App />, mountPoint);
}

function getObject(key) {
    return JSON.parse(localStorage.getItem(key));
}

function setObject(key, obj) {
    localStorage.setItem(key, JSON.stringify(obj))
    return obj;
}

function getModel() {
    return getObject("model");
}

function setModel(obj) {
    setObject("model", obj);
    updateView();
}


//CONTROLLERS
function handleGetData() {
        fetch(DATA_SERVER_URL)
            .then(handleErrors)
            .then(response => response.json())
            .then(function(response) {
                setModel({
                    ...getModel(),
                    data: [...getModel().data, response]
                });
                console.log(getModel().data);
            })
            .catch(error => console.log(error))
}

function handleClick() {
    setModel({
        ...getModel(),
        isStreamOn: !getModel().isStreamOn
    });
}

function handleErrors(response) {
    if (!response.ok) {
        throw Error(response.statusText);
    }
    return response;
}


// VIEW
function Node(props) {
    return <span> {props.data} </span>;
}

function createGraphNode(json, i) {
    const { data, id, type } = json;
    return <Node data={data} key={id} />;
}

function App() {
    useEffect(function() {
        const interval = setInterval(function() {
            if(getModel().isStreamOn) {
                handleGetData();
            }             
        },
            1000
        );

        return () => clearInterval(interval);

    }, []);

    return (
        <React.Fragment>
            <h1>Graph</h1>
            <Meter/>
            <button
                onClick={ handleClick }
            >
                { !getModel().isStreamOn ? "Turn stream on" : "Turn stream off" }
            </button>
        </React.Fragment>
    );
}

function Meter(){
    return (
        <React.Fragment>
            <div id="meter">{getModel().data.map(createGraphNode)}</div>
        </React.Fragment> 
    );
}

ReactDOM.render(
    <App />,
    MOUNT_POINT
);



</script>
</body>
</html>
